<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日排便记录 - 健康生活的点滴</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            scroll-behavior: smooth;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .loader {
            animation: fadeIn 0.5s ease-in;
        }
        
        .page-transition {
            opacity: 0;
            animation: fadeIn 0.8s ease-in forwards;
            animation-delay: 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .hover-scale {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        .loading-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        
        /* Bristol大便分类图示样式 */
        .bristol-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
        }
        
        .bristol-item {
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .stool-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: #fff;
            color: #1f2937;
        }
        
        .dark .form-control {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 0.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        /* 响应式调整 */
        @media (max-width: 640px) {
            .bristol-types {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
    <script>
        // 定义Tailwind暗模式配置
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6b7280'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen">
    <!-- 加载动画 -->
    <div id="loading" class="loading-wrapper bg-gray-50 dark:bg-gray-900">
        <div class="text-center max-w-lg mx-auto px-4">
            <div class="mb-6">
                <svg class="animate-spin mx-auto h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h2 id="current-date" class="text-2xl font-bold mb-4"></h2>
            <blockquote class="border-l-4 border-blue-500 pl-4 italic">
                <p id="quote" class="text-lg mb-2"></p>
                <footer id="quote-source" class="text-sm text-gray-600 dark:text-gray-400"></footer>
            </blockquote>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div id="main-content" class="hidden">
        <!-- 导航栏 -->
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <i class="fas fa-toilet text-blue-600 text-2xl mr-3"></i>
                        <h1 class="text-xl font-bold">每日排便记录</h1>
                    </div>
                    <div>
                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:block"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 内容区域 -->
        <main class="container mx-auto px-4 py-8">
            <!-- 统计摘要卡片 -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-blue-100 dark:bg-blue-900 rounded-full p-3 mr-4">
                            <i class="fas fa-calendar-check text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h3 class="text-sm text-gray-600 dark:text-gray-400">本周记录</h3>
                            <p class="text-2xl font-bold">0/7</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <i class="fas fa-minus"></i> 尚无数据
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-purple-100 dark:bg-purple-900 rounded-full p-3 mr-4">
                            <i class="fas fa-clock text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <div>
                            <h3 class="text-sm text-gray-600 dark:text-gray-400">平均时长</h3>
                            <p class="text-2xl font-bold">--</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <i class="fas fa-minus"></i> 尚无数据
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-amber-100 dark:bg-amber-900 rounded-full p-3 mr-4">
                            <i class="fas fa-chart-line text-amber-600 dark:text-amber-400"></i>
                        </div>
                        <div>
                            <h3 class="text-sm text-gray-600 dark:text-gray-400">平均布里斯托评分</h3>
                            <p class="text-2xl font-bold">--</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <i class="fas fa-minus"></i> 尚无数据
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 图表分析 -->
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">近期趋势分析</h2>
                <div id="no-chart-data" class="flex flex-col items-center justify-center py-16">
                    <i class="fas fa-chart-area text-gray-300 dark:text-gray-700 text-5xl mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">尚无数据可供分析，请添加排便记录</p>
                </div>
                <div id="chart-container" class="h-80 hidden">
                    <canvas id="trends-chart"></canvas>
                </div>
            </section>

            <!-- 布里斯托大便分类表 -->
            <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">布里斯托大便分类表</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">布里斯托大便分类表(Bristol Stool Chart)是医学上用于分类人类粪便形态的诊断性医疗工具</p>
                
                <div class="bristol-types mt-6 mb-4">
              <div class="bristol-types mt-6 mb-4">
    <!-- 布里斯托7种类型 -->
    <div class="bristol-item bg-gray-100 dark:bg-gray-700 p-4 text-center hover-scale">
        <div class="stool-icon text-amber-800">
            <i class="fas fa-circle"></i><i class="fas fa-circle"></i>
        </div>
        <div class="font-bold mb-1">硬块状</div>
        <div class="text-sm">如坚果</div>
    </div>
    <div class="bristol-item bg-gray-100 dark:bg-gray-700 p-4 text-center hover-scale">
        <div class="stool-icon text-amber-700">
            <i class="fas fa-pills fa-rotate-90"></i>
        </div>
        <div class="font-bold mb-1">结块状</div>
        <div class="text-sm">条状但有结块</div>
    </div>
    <div class="bristol-item bg-gray-100 dark:bg-gray-700 p-4 text-center hover-scale">
        <div class="stool-icon text-amber-600">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                <path d="M6,12 C6,9 8,8 12,8 C16,8 18,9 18,12 C18,15 16,16 12,16 C8,16 6,15 6,12 Z"></path>
            </svg>
        </div>
        <div class="font-bold mb-1">裂纹状</div>
        <div class="text-sm">条状有裂纹</div>
    </div>
    <div class="bristol-item bg-gray-100 dark:bg-gray-700 p-4 text-center hover-scale">
        <div class="stool-icon text-amber-500">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                <path d="M5,12 C5,9 8,7 12,7 C16,7 19,9 19,12 C19,15 16,17 12,17 C8,17 5,15 5,12 Z"></path>
            </svg>
        </div>
        <div class="font-bold mb-1">光滑条状</div>
        <div class="text-sm">条状光滑(最理想)</div>
    </div>
    <div class="bristol-item bg-gray-100 dark:bg-gray-700 p-4 text-center hover-scale">
        <div class="stool-icon text-amber-500">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                <path d="M7,10 C7,8.5 9,7 12,7 C15,7 17,8.5 17,10 C17,11.5 15,13 12,13 C9,13 7,11.5 7,10 Z"></path>
                <path d="M9,14 C9,12.5 10,12 12,12 C14,12 15,12.5 15,14 C15,15.5 14,16 12,16 C10,16 9,15.5 9,14 Z"></path>
            </svg>
        </div>
        <div class="font-bold mb-1">软块状</div>
        <div class="text-sm">软块状有清晰边缘</div>
    </div>
    <div class="bristol-item bg-gray-100 dark:bg-gray-700 p-4 text-center hover-scale">
        <div class="stool-icon text-amber-400">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                <path d="M6,10 C6,8 9,7 12,7 C15,7 18,8 18,10 C18,10.5 17.5,11 16.5,11.5 C17.5,12 18,12.5 18,13 C18,15 15,16 12,16 C9,16 6,15 6,13 C6,12.5 6.5,12 7.5,11.5 C6.5,11 6,10.5 6,10 Z"></path>
            </svg>
        </div>
        <div class="font-bold mb-1">糊状</div>
        <div class="text-sm">糊状软便，边缘不规则</div>
    </div>
    <div class="bristol-item bg-gray-100 dark:bg-gray-700 p-4 text-center hover-scale">
        <div class="stool-icon text-amber-300">
            <i class="fas fa-water"></i>
        </div>
        <div class="font-bold mb-1">水状</div>
        <div class="text-sm">全液态，无固体</div>
    </div>
</div>

            </section>

            <!-- 最近记录 -->
            <section class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">最近记录</h2>
                    <button id="add-record-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg flex items-center hover-scale">
                        <i class="fas fa-plus mr-2"></i> 新增记录
                    </button>
                </div>
                
                <!-- 空记录状态 -->
                <div id="empty-records" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-10 text-center">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-toilet-paper text-gray-300 dark:text-gray-700 text-6xl mb-4"></i>
                        <h3 class="text-xl font-medium mb-2">暂无排便记录</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">点击"新增记录"按钮开始记录您的排便情况</p>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg flex items-center hover-scale" onclick="document.getElementById('add-record-btn').click()">
                            <i class="fas fa-plus mr-2"></i> 开始记录
                        </button>
                    </div>
                </div>
                
                <!-- 记录列表 (初始为空) -->
                <div id="records-list" class="space-y-4 hidden">
                    <!-- 记录项将通过JavaScript动态添加 -->
                </div>
            </section>
        </main>

        <!-- 页脚 -->
        <footer class="bg-white dark:bg-gray-800 py-8 mt-8 border-t border-gray-200 dark:border-gray-700">
            <div class="container mx-auto px-4">
                <div class="text-center sm:text-left flex flex-col sm:flex-row justify-between items-center">
                    <div class="mb-4 sm:mb-0">
                        <p class="text-gray-600 dark:text-gray-400">&copy; <span id="current-year"></span> 张三 版权所有</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">健康记录，只为更好的生活</p>
                    </div>
                    <div class="flex gap-4">
                        <a href="https://github.com/username" target="_blank" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                            <i class="fab fa-github text-xl"></i>
                        </a>
                        <a href="https://twitter.com/username" target="_blank" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="https://linkedin.com/in/username" target="_blank" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                            <i class="fab fa-linkedin text-xl"></i>
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- 新增记录模态框 -->
    <div id="add-record-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">新增排便记录</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="record-form" class="mt-4">
                <div class="form-group">
                    <label class="form-label" for="record-date">日期时间</label>
                    <input type="datetime-local" id="record-date" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="record-duration">持续时间（分钟）</label>
                    <input type="number" id="record-duration" class="form-control" min="1" max="60" required>
                </div>
                
                <div class="form-group">
              <div class="form-group">
    <label class="form-label">大便类型（布里斯托量表）</label>
    <div class="grid grid-cols-4 gap-2">
        <label class="cursor-pointer">
            <input type="radio" name="bristol-type" value="1" class="sr-only" required>
            <div class="border-2 border-transparent hover:border-blue-500 p-2 rounded-md text-center bg-gray-100 dark:bg-gray-700">
                <div class="text-amber-800 text-2xl">
                    <i class="fas fa-circle"></i><i class="fas fa-circle"></i>
                </div>
                <span class="block mt-1 text-xs">硬块状</span>
            </div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="bristol-type" value="2" class="sr-only">
            <div class="border-2 border-transparent hover:border-blue-500 p-2 rounded-md text-center bg-gray-100 dark:bg-gray-700">
                <div class="text-amber-700 text-2xl">
                    <i class="fas fa-pills fa-rotate-90"></i>
                </div>
                <span class="block mt-1 text-xs">结块状</span>
            </div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="bristol-type" value="3" class="sr-only">
            <div class="border-2 border-transparent hover:border-blue-500 p-2 rounded-md text-center bg-gray-100 dark:bg-gray-700">
                <div class="text-amber-600 text-2xl">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                        <path d="M6,12 C6,9 8,8 12,8 C16,8 18,9 18,12 C18,15 16,16 12,16 C8,16 6,15 6,12 Z"></path>
                    </svg>
                </div>
                <span class="block mt-1 text-xs">裂纹状</span>
            </div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="bristol-type" value="4" class="sr-only">
            <div class="border-2 border-transparent hover:border-blue-500 p-2 rounded-md text-center bg-gray-100 dark:bg-gray-700">
                <div class="text-amber-500 text-2xl">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                        <path d="M5,12 C5,9 8,7 12,7 C16,7 19,9 19,12 C19,15 16,17 12,17 C8,17 5,15 5,12 Z"></path>
                    </svg>
                </div>
                <span class="block mt-1 text-xs">光滑条状</span>
            </div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="bristol-type" value="5" class="sr-only">
            <div class="border-2 border-transparent hover:border-blue-500 p-2 rounded-md text-center bg-gray-100 dark:bg-gray-700">
                <div class="text-amber-500 text-2xl">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                        <path d="M7,10 C7,8.5 9,7 12,7 C15,7 17,8.5 17,10 C17,11.5 15,13 12,13 C9,13 7,11.5 7,10 Z"></path>
                        <path d="M9,14 C9,12.5 10,12 12,12 C14,12 15,12.5 15,14 C15,15.5 14,16 12,16 C10,16 9,15.5 9,14 Z"></path>
                    </svg>
                </div>
                <span class="block mt-1 text-xs">软块状</span>
            </div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="bristol-type" value="6" class="sr-only">
            <div class="border-2 border-transparent hover:border-blue-500 p-2 rounded-md text-center bg-gray-100 dark:bg-gray-700">
                <div class="text-amber-400 text-2xl">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                        <path d="M6,10 C6,8 9,7 12,7 C15,7 18,8 18,10 C18,10.5 17.5,11 16.5,11.5 C17.5,12 18,12.5 18,13 C18,15 15,16 12,16 C9,16 6,15 6,13 C6,12.5 6.5,12 7.5,11.5 C6.5,11 6,10.5 6,10 Z"></path>
                    </svg>
                </div>
                <span class="block mt-1 text-xs">糊状</span>
            </div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="bristol-type" value="7" class="sr-only">
            <div class="border-2 border-transparent hover:border-blue-500 p-2 rounded-md text-center bg-gray-100 dark:bg-gray-700">
                <div class="text-amber-300 text-2xl">
                    <i class="fas fa-water"></i>
                </div>
                <span class="block mt-1 text-xs">水状</span>
            </div>
        </label>
    </div>
</div>
                
                <div class="form-group">
                    <label class="form-label" for="record-hardness">硬度</label>
                    <select id="record-hardness" class="form-control" required>
                        <option value="">请选择</option>
                        <option value="很硬">很硬</option>
                        <option value="较硬">较硬</option>
                        <option value="适中">适中</option>
                        <option value="较软">较软</option>
                        <option value="很软">很软</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="record-mood">心情</label>
                    <select id="record-mood" class="form-control" required>
                        <option value="">请选择</option>
                        <option value="很愉快">很愉快 😄</option>
                        <option value="愉快">愉快 🙂</option>
                        <option value="一般">一般 😐</option>
                        <option value="不适">不适 🙁</option>
                        <option value="很不适">很不适 😖</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="record-notes">备注</label>
                    <textarea id="record-notes" class="form-control" rows="3" placeholder="添加额外说明..."></textarea>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button type="button" id="cancel-record" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg mr-2">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">保存记录</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 日期格式化函数
        function formatDate(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}年${month}月${day}日`;
        }

        function formatDateTime(dateObj) {
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth() + 1;
            const day = dateObj.getDate();
            const hours = dateObj.getHours().toString().padStart(2, '0');
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
            
            return `${year}年${month}月${day}日 ${hours}:${minutes}`;
        }

        // 布里斯托大便类型图标获取函数
// 获取布里斯托类型名称函数
function getBristolTypeName(type) {
    switch(parseInt(type)) {
        case 1: return '硬块状';
        case 2: return '结块状';
        case 3: return '裂纹状';
        case 4: return '光滑条状';
        case 5: return '软块状';
        case 6: return '糊状';
        case 7: return '水状';
        default: return '未知类型';
    }
}

        // 获取心情表情函数
        function getMoodIcon(mood) {
            switch(mood) {
                case '很愉快':
                    return '<i class="far fa-grin text-green-500"></i>';
                case '愉快':
                    return '<i class="far fa-smile text-green-400"></i>';
                case '一般':
                    return '<i class="far fa-meh text-yellow-500"></i>';
                case '不适':
                    return '<i class="far fa-frown text-orange-500"></i>';
                case '很不适':
                    return '<i class="far fa-dizzy text-red-500"></i>';
                default:
                    return '<i class="far fa-question-circle text-gray-400"></i>';
            }
        }

        // 数据存储
        let records = [];
        const storedRecords = localStorage.getItem('poop-records');
        if (storedRecords) {
            try {
                records = JSON.parse(storedRecords);
                // 转换字符串日期为Date对象
                records.forEach(record => {
                    record.date = new Date(record.date);
                });
            } catch (e) {
                console.error("Failed to parse stored records:", e);
                records = [];
            }
        }

        // 当页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化日期显示
            const today = new Date();
            document.getElementById('current-date').textContent = `今天是${formatDate(today)}`;
            document.getElementById('current-year').textContent = today.getFullYear();
            
            // 默认填入当前日期时间
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('record-date').value = now.toISOString().slice(0, 16);
            
            // 模拟名人名言API (实际应用中应替换为真实API)
            const quotes = [
                {
                    text: "便便是身体的语言，它诉说着你内心最深处的秘密。",
                    source: "《肠道的秘密》，朱利安·特鲁尔"
                },
                {
                    text: "人与动物的区别在于，人类会思考自己的排泄物，并从中寻找健康的答案。",
                    source: "《肠道健康与免疫》，埃默兰·迈耶"
                },
                {
                    text: "如厕时间是人类为数不多能够独处并与自己对话的时刻。",
                    source: "《思考的艺术》，李欧纳多·达·芬奇"
                },
                {
                    text: "每一次排便都是身体进行自我清理的仪式，值得尊重和关注。",
                    source: "《身体的智慧》，迈克尔·波兰"
                },
                {
                    text: "观察你的排泄物，是理解自己健康状况的第一步。",
                    source: "《生活中的医学》，安德鲁·威尔"
                }
            ];
            
            // 随机选择一条名言
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('quote').textContent = randomQuote.text;
            document.getElementById('quote-source').textContent = randomQuote.source;
            
            // 设置定时器，3秒后隐藏加载页面，显示主内容
            setTimeout(function() {
                document.getElementById('loading').classList.add('opacity-0');
                setTimeout(function() {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('page-transition');
                    
                    // 更新UI以显示记录
                    updateUI();
                }, 500);
            }, 3000);
            
            // 深色模式切换
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
            });
            
            // 检查系统偏好并应用
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            // 模态框处理
            const modal = document.getElementById('add-record-modal');
            const addRecordBtn = document.getElementById('add-record-btn');
            const closeModalBtn = document.getElementById('close-modal');
            const cancelBtn = document.getElementById('cancel-record');
            const recordForm = document.getElementById('record-form');
            
            // 打开模态框
            addRecordBtn.addEventListener('click', function() {
                modal.classList.add('show');
            });
            
            // 关闭模态框
            function closeModal() {
                modal.classList.remove('show');
            }
            
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // 提交表单
            recordForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // 收集表单数据
                const dateInput = document.getElementById('record-date').value;
                const duration = document.getElementById('record-duration').value;
                const bristolType = document.querySelector('input[name="bristol-type"]:checked').value;
                const hardness = document.getElementById('record-hardness').value;
                const mood = document.getElementById('record-mood').value;
                const notes = document.getElementById('record-notes').value;
                
                // 创建记录对象
                const newRecord = {
                    id: Date.now(), // 使用时间戳作为唯一ID
                    date: new Date(dateInput),
                    duration: parseInt(duration),
                    bristolType: parseInt(bristolType),
                    hardness: hardness,
                    mood: mood,
                    notes: notes
                };
                
                // 添加到记录中
                records.push(newRecord);
                
                // 按日期排序（最近的在前面）
                records.sort((a, b) => b.date - a.date);
                
                // 保存到本地存储
                localStorage.setItem('poop-records', JSON.stringify(records));
                
                // 更新UI
                updateUI();
                
                // 关闭模态框
                closeModal();
                
                // 重置表单
                recordForm.reset();
                
                // 重新设置默认日期时间
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('record-date').value = now.toISOString().slice(0, 16);
            });
        });
        
        // 更新UI函数
        function updateUI() {
            const emptyRecordsEl = document.getElementById('empty-records');
            const recordsListEl = document.getElementById('records-list');
            const noChartDataEl = document.getElementById('no-chart-data');
            const chartContainerEl = document.getElementById('chart-container');
            
            // 检查是否有记录
            if (records.length === 0) {
                emptyRecordsEl.classList.remove('hidden');
                recordsListEl.classList.add('hidden');
                noChartDataEl.classList.remove('hidden');
                chartContainerEl.classList.add('hidden');
                return;
            }
            
            // 有记录，更新UI
            emptyRecordsEl.classList.add('hidden');
            recordsListEl.classList.remove('hidden');
            noChartDataEl.classList.add('hidden');
            chartContainerEl.classList.remove('hidden');
            
            // 生成记录列表HTML
            recordsListEl.innerHTML = '';
            
            records.forEach(record => {
                const recordEl = document.createElement('div');
                recordEl.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 hover-scale';
                recordEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold">${formatDateTime(record.date)}</h3>
                            <span class="inline-block text-xs px-2 py-1 rounded-full mt-1 bg-gray-100 dark:bg-gray-700">
                                ${getMoodIcon(record.mood)} ${record.mood}
                            </span>
                        </div>
                        <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs px-2 py-1 rounded-full">时长: ${record.duration}分钟</span>
                    </div>
                    <div class="flex flex-wrap gap-4 mb-2">
                        <div class="flex items-center">
                            <span class="text-gray-600 dark:text-gray-400 text-sm">形状：</span>
                            <span class="font-medium flex items-center">
                                <span class="mr-1">类型${record.bristolType}</span>
                                <span class="inline-block">${getBristolTypeIcon(record.bristolType)}</span>
                            </span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-600 dark:text-gray-400 text-sm">硬度：</span>
                            <span class="font-medium">${record.hardness}</span>
                        </div>
                    </div>
                    ${record.notes ? `<p class="text-gray-600 dark:text-gray-400 text-sm">备注：${record.notes}</p>` : ''}
                `;
                
                recordsListEl.appendChild(recordEl);
            });
            
            // 更新统计数据
            updateStats();
            
            // 初始化图表
            initChart();
        }
        
        // 更新统计数据
        function updateStats() {
            // 获取当前日期
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 计算一周前的日期
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // 过滤出本周的记录
            const thisWeekRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                recordDate.setHours(0, 0, 0, 0);
                return recordDate >= oneWeekAgo && recordDate <= today;
            });
            
            // 更新本周记录数
            const weeklyRecordsEl = document.querySelector('.container .grid.grid-cols-1.md\\:grid-cols-3 > div:nth-child(1) p.text-2xl');
            if (weeklyRecordsEl) {
                weeklyRecordsEl.textContent = `${thisWeekRecords.length}/7`;
                
                const weeklyRecordsStatusEl = weeklyRecordsEl.nextElementSibling;
                if (thisWeekRecords.length > 0) {
                    weeklyRecordsStatusEl.innerHTML = `<i class="fas fa-check"></i> 已记录`;
                    weeklyRecordsStatusEl.className = 'text-xs text-green-600 dark:text-green-400 mt-1';
                } else {
                    weeklyRecordsStatusEl.innerHTML = `<i class="fas fa-minus"></i> 尚无数据`;
                    weeklyRecordsStatusEl.className = 'text-xs text-gray-500 dark:text-gray-400 mt-1';
                }
            }
            
            // 更新平均时长
            const durationEl = document.querySelector('.container .grid.grid-cols-1.md\\:grid-cols-3 > div:nth-child(2) p.text-2xl');
            if (durationEl && records.length > 0) {
                const avgDuration = records.reduce((sum, record) => sum + record.duration, 0) / records.length;
                durationEl.textContent = `${avgDuration.toFixed(1)}分钟`;
                
                const durationStatusEl = durationEl.nextElementSibling;
                durationStatusEl.innerHTML = `<i class="fas fa-check"></i> 已记录`;
                durationStatusEl.className = 'text-xs text-green-600 dark:text-green-400 mt-1';
            }
            
            // 更新布里斯托评分
            const bristolEl = document.querySelector('.container .grid.grid-cols-1.md\\:grid-cols-3 > div:nth-child(3) p.text-2xl');
            if (bristolEl && records.length > 0) {
                const avgBristol = records.reduce((sum, record) => sum + record.bristolType, 0) / records.length;
                bristolEl.textContent = avgBristol.toFixed(1);
                
                const bristolStatusEl = bristolEl.nextElementSibling;
                if (avgBristol >= 3 && avgBristol <= 5) {
                    bristolStatusEl.innerHTML = `<i class="fas fa-check"></i> 健康范围内`;
                    bristolStatusEl.className = 'text-xs text-green-600 dark:text-green-400 mt-1';
                } else {
                    bristolStatusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 非理想范围`;
                    bristolStatusEl.className = 'text-xs text-orange-600 dark:text-orange-400 mt-1';
                }
            }
        }
        
        // 初始化图表
        function initChart() {
            if (records.length === 0) return;
            
            const ctx = document.getElementById('trends-chart').getContext('2d');
            
            // 清除任何现有图表
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#9ca3af' : '#6b7280';
            
            // 准备图表数据
            const sortedRecords = [...records].sort((a, b) => a.date - b.date);
            const lastRecords = sortedRecords.slice(-7); // 获取最近7条记录
            
            const labels = lastRecords.map(record => {
                const date = new Date(record.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const bristolData = lastRecords.map(record => record.bristolType);
            const durationData = lastRecords.map(record => record.duration);
            
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '布里斯托评分',
                            data: bristolData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '排便时长(分钟)',
                            data: durationData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: textColor
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            },
                            min: 0,
                            max: 10
                        }
                    }
                }
            });
        }

        // 为布里斯托类型选择添加高亮效果
        document.querySelectorAll('input[name="bristol-type"]').forEach(input => {
            input.addEventListener('change', function() {
                // 移除所有选中样式
                document.querySelectorAll('input[name="bristol-type"] + div').forEach(div => {
                    div.classList.remove('border-blue-500');
                    div.classList.add('border-transparent');
                });
                
                // 添加选中样式
                if (this.checked) {
                    this.nextElementSibling.classList.remove('border-transparent');
                    this.nextElementSibling.classList.add('border-blue-500');
                }
            });
        });
    </script>
</body>
</html>
